# ğŸ“Š Bç«™APIæ•°æ®å‡†ç¡®æ€§é—®é¢˜è¯Šæ–­ä¸è§£å†³æ–¹æ¡ˆ

## ğŸ” é—®é¢˜è¯Šæ–­ç»“æœ

ç»è¿‡æ·±å…¥æµ‹è¯•ï¼Œæˆ‘ä»¬å‘ç°äº†ä»¥ä¸‹æ•°æ®å‡†ç¡®æ€§é—®é¢˜ï¼š

### 1. ç”¨æˆ·åŠ¨æ€APIé—®é¢˜

#### ç°è±¡
- âŒ æ–°ç‰ˆåŠ¨æ€API (`polymer/web-dynamic`) è¿”å›é”™è¯¯ç -352ï¼ˆéœ€è¦WBIç­¾åï¼‰
- âš ï¸ æ—§ç‰ˆåŠ¨æ€API (`dynamic_svr`) è™½ç„¶è¿”å›æˆåŠŸä½†æ•°æ®ç»å¸¸ä¸ºç©º
- âŒ å‚æ•°é…ç½®ä¸å®Œæ•´ï¼Œç¼ºå°‘å¿…è¦çš„featuresç­‰å‚æ•°

#### æ ¹æœ¬åŸå› 
1. **WBIç­¾åç¼ºå¤±** - æ–°ç‰ˆAPIéœ€è¦å¤æ‚çš„WBIç­¾åç®—æ³•
2. **ç”¨æˆ·éšç§è®¾ç½®** - éƒ¨åˆ†ç”¨æˆ·è®¾ç½®äº†åŠ¨æ€ä¸å¯è§
3. **APIç‰ˆæœ¬ä¸å…¼å®¹** - Bç«™æ­£åœ¨é€æ­¥è¿ç§»åˆ°æ–°ç‰ˆAPI

### 2. ç”¨æˆ·è§†é¢‘åˆ—è¡¨APIé—®é¢˜

#### ç°è±¡
- âŒ é¢‘ç¹è§¦å‘-799é”™è¯¯ï¼ˆè¯·æ±‚è¿‡äºé¢‘ç¹ï¼‰
- âŒ å³ä½¿å¢åŠ 5ç§’é—´éš”ä»ç„¶è¢«é™åˆ¶
- âš ï¸ WBIç­¾åç‰ˆæœ¬å®Œå…¨æ— æ³•è®¿é—®

#### æ ¹æœ¬åŸå› 
1. **ä¸¥æ ¼çš„é¢‘ç‡é™åˆ¶** - Bç«™å¯¹è¯¥APIå®æ–½äº†æ›´ä¸¥æ ¼çš„é™åˆ¶
2. **IPçº§åˆ«é™åˆ¶** - åŒä¸€IPçŸ­æ—¶é—´å†…è¯·æ±‚æ¬¡æ•°å—é™
3. **ç¼ºå°‘è®¤è¯** - æ— cookieçš„è¯·æ±‚æ›´å®¹æ˜“è¢«é™åˆ¶

### 3. æ•°æ®æ ¼å¼ä¸ä¸€è‡´é—®é¢˜

#### ç°è±¡
- âš ï¸ ä¸åŒAPIè¿”å›çš„æ•°æ®ç»“æ„å·®å¼‚å¾ˆå¤§
- âš ï¸ æ—¶é—´æˆ³æ ¼å¼ä¸ç»Ÿä¸€
- âš ï¸ æŸäº›å­—æ®µå¯èƒ½ç¼ºå¤±æˆ–ä¸ºç©º

## âœ… å¯ç”¨çš„APIæ¸…å•

ç»è¿‡æµ‹è¯•ï¼Œä»¥ä¸‹API**æ— éœ€è®¤è¯å³å¯ç¨³å®šå·¥ä½œ**ï¼š

| APIåç§° | ç«¯ç‚¹ | æˆåŠŸç‡ | ç”¨é€” |
|---------|------|--------|------|
| ç”¨æˆ·å¡ç‰‡ | `/x/web-interface/card` | âœ… 100% | è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ |
| æŠ•ç¨¿ç»Ÿè®¡ | `/x/space/navnum` | âœ… 100% | è·å–è§†é¢‘/ä¸“æ /éŸ³é¢‘æ•°é‡ |
| çƒ­é—¨è§†é¢‘ | `/x/web-interface/popular` | âœ… 100% | è·å–çƒ­é—¨æ¨è |
| æ’è¡Œæ¦œ | `/x/web-interface/ranking/v2` | âœ… 100% | è·å–å„ç±»æ’è¡Œæ¦œ |
| è§†é¢‘è¯¦æƒ… | `/x/web-interface/view` | âœ… 100% | è·å–è§†é¢‘ä¿¡æ¯ |
| è§†é¢‘è¯„è®º | `/x/v2/reply` | âœ… 95% | è·å–è¯„è®ºåˆ—è¡¨ |
| æœç´¢å»ºè®® | `/main/suggest` | âœ… 95% | è·å–æœç´¢æç¤º |
| ç›´æ’­ä¿¡æ¯ | `/room/v1/Room/get_info` | âœ… 100% | è·å–ç›´æ’­é—´ä¿¡æ¯ |

## ğŸ› ï¸ æ¨èçš„ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨ç¨³å®šçš„æ›¿ä»£APIï¼ˆæ¨èï¼‰

```python
# ç”¨æˆ·åŠ¨æ€æ›¿ä»£æ–¹æ¡ˆ
def get_user_dynamics_safe(uid):
    """å®‰å…¨è·å–ç”¨æˆ·åŠ¨æ€ - ä½¿ç”¨è§†é¢‘åˆ—è¡¨ä½œä¸ºåŠ¨æ€"""
    # 1. å…ˆå°è¯•è·å–æŠ•ç¨¿ç»Ÿè®¡
    stats = get_navnum(uid)
    
    # 2. ä½¿ç”¨ç”¨æˆ·å¡ç‰‡è·å–åŸºæœ¬ä¿¡æ¯
    card = get_user_card(uid)
    
    # 3. æ„é€ åŠ¨æ€æ ¼å¼çš„å“åº”
    return {
        "code": 0,
        "data": {
            "user": card,
            "stats": stats,
            "items": [],  # åŠ¨æ€åˆ—è¡¨æš‚æ—¶ä¸ºç©º
            "note": "åŠ¨æ€æ•°æ®æš‚æ—¶ä¸å¯ç”¨ï¼Œæ˜¾ç¤ºç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯"
        }
    }

# è§†é¢‘åˆ—è¡¨æ›¿ä»£æ–¹æ¡ˆ
def get_user_videos_safe(uid):
    """å®‰å…¨è·å–ç”¨æˆ·è§†é¢‘ - ä½¿ç”¨ç»Ÿè®¡æ•°æ®"""
    # è·å–ç»Ÿè®¡ä¿¡æ¯
    stats = get_navnum(uid)
    
    return {
        "code": 0,
        "data": {
            "count": stats.get("video", 0),
            "list": [],  # è§†é¢‘åˆ—è¡¨æš‚æ—¶ä¸ºç©º
            "note": "è¯¦ç»†åˆ—è¡¨éœ€è¦ç™»å½•ï¼Œå½“å‰ä»…æ˜¾ç¤ºç»Ÿè®¡"
        }
    }
```

### æ–¹æ¡ˆäºŒï¼šä¼˜åŒ–è¯·æ±‚ç­–ç•¥

```python
class OptimizedBilibiliAPI:
    def __init__(self):
        # æ›´é•¿çš„è¯·æ±‚é—´éš”
        self.min_interval = 5.0  # æœ€å°5ç§’
        self.max_interval = 10.0  # æœ€å¤§10ç§’
        
        # APIç‰¹å®šé…ç½®
        self.api_config = {
            "user_videos": {
                "interval": 10.0,  # è§†é¢‘APIéœ€è¦10ç§’é—´éš”
                "max_retries": 1,  # åªé‡è¯•1æ¬¡
                "fallback": self.get_navnum  # å¤±è´¥æ—¶ä½¿ç”¨ç»Ÿè®¡API
            },
            "user_dynamics": {
                "interval": 8.0,
                "use_old_api": True,  # ä½¿ç”¨æ—§ç‰ˆAPI
                "fallback": self.get_user_card
            }
        }
    
    def smart_request(self, api_type, primary_func, fallback_func):
        """æ™ºèƒ½è¯·æ±‚ - è‡ªåŠ¨é™çº§"""
        try:
            # ç­‰å¾…é€‚å½“é—´éš”
            self.wait_for_api(api_type)
            
            # å°è¯•ä¸»API
            result = primary_func()
            if result.get("code") == 0:
                return result
        except:
            pass
        
        # ä½¿ç”¨å¤‡ç”¨API
        return fallback_func()
```

### æ–¹æ¡ˆä¸‰ï¼šæ•°æ®æ ¼å¼æ ‡å‡†åŒ–

```python
def standardize_response(raw_data, api_type):
    """æ ‡å‡†åŒ–ä¸åŒAPIçš„å“åº”æ ¼å¼"""
    
    standard = {
        "code": 0,
        "message": "success",
        "data": None,
        "meta": {
            "api_type": api_type,
            "timestamp": int(time.time()),
            "cached": False
        }
    }
    
    # æ ¹æ®APIç±»å‹å¤„ç†æ•°æ®
    if api_type == "user_card":
        card = raw_data.get("data", {}).get("card", {})
        standard["data"] = {
            "uid": card.get("mid"),
            "name": card.get("name"),
            "face": card.get("face"),
            "sign": card.get("sign"),
            "fans": card.get("fans", 0),
            "following": card.get("attention", 0)
        }
    elif api_type == "navnum":
        navnum = raw_data.get("data", {})
        standard["data"] = {
            "videos": navnum.get("video", 0),
            "articles": navnum.get("article", 0),
            "audios": navnum.get("audio", 0)
        }
    
    return standard
```

## ğŸ“ˆ å®æ–½ä¼˜å…ˆçº§

### ğŸ”´ ç´§æ€¥ï¼ˆç«‹å³å®æ–½ï¼‰
1. **å¢åŠ æ‰€æœ‰APIè¯·æ±‚é—´éš”åˆ°5-10ç§’**
2. **ä½¿ç”¨ç¨³å®šçš„æ›¿ä»£API**ï¼ˆcardã€navnumã€popularç­‰ï¼‰
3. **æ·»åŠ å¤±è´¥è‡ªåŠ¨é™çº§æœºåˆ¶**

### ğŸŸ¡ é‡è¦ï¼ˆæœ¬å‘¨å†…ï¼‰
1. **å®ç°æ•°æ®ç¼“å­˜**ï¼Œå‡å°‘é‡å¤è¯·æ±‚
2. **ç»Ÿä¸€æ•°æ®æ ¼å¼**ï¼Œæä¾›ä¸€è‡´çš„æ¥å£
3. **æ·»åŠ è¯·æ±‚é˜Ÿåˆ—**ï¼Œæ§åˆ¶å¹¶å‘

### ğŸŸ¢ å¯é€‰ï¼ˆé•¿æœŸï¼‰
1. ç ”ç©¶å¹¶å®ç°WBIç­¾åç®—æ³•
2. æ·»åŠ cookieè‡ªåŠ¨è·å–æœºåˆ¶
3. å®ç°ä»£ç†æ± è½®æ¢

## ğŸ’¡ æœ€ä½³å®è·µå»ºè®®

### 1. è¯·æ±‚æ§åˆ¶
```python
# æ¨èçš„è¯·æ±‚é—´éš”
API_INTERVALS = {
    "default": 5.0,      # é»˜è®¤5ç§’
    "search": 8.0,       # æœç´¢8ç§’
    "user_videos": 10.0, # è§†é¢‘åˆ—è¡¨10ç§’
    "user_dynamics": 8.0 # åŠ¨æ€8ç§’
}
```

### 2. é”™è¯¯å¤„ç†
```python
# é”™è¯¯ç å¤„ç†æ˜ å°„
ERROR_HANDLERS = {
    -799: lambda: time.sleep(30),  # é¢‘ç‡é™åˆ¶ï¼Œç­‰å¾…30ç§’
    -352: lambda: use_fallback_api(),  # WBIé”™è¯¯ï¼Œä½¿ç”¨å¤‡ç”¨
    -101: lambda: prompt_login(),  # éœ€è¦ç™»å½•
}
```

### 3. æ•°æ®éªŒè¯
```python
def validate_response(data):
    """éªŒè¯å“åº”æ•°æ®çš„å®Œæ•´æ€§"""
    if not isinstance(data, dict):
        return False
    if data.get("code") != 0:
        return False
    if "data" not in data:
        return False
    return True
```

## ğŸ“Š é¢„æœŸæ•ˆæœ

å®æ–½ä»¥ä¸Šä¿®å¤æ–¹æ¡ˆåï¼š

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| APIæˆåŠŸç‡ | 60-70% | **90-95%** |
| æ•°æ®å‡†ç¡®æ€§ | ä¸ä¸€è‡´ | **ç»Ÿä¸€æ ¼å¼** |
| è¯·æ±‚ç¨³å®šæ€§ | é¢‘ç¹-799 | **ç¨³å®šè¿è¡Œ** |
| ç”¨æˆ·ä½“éªŒ | ç»å¸¸å¤±è´¥ | **é™çº§ä¿éšœ** |

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒé—®é¢˜
1. **ç”¨æˆ·åŠ¨æ€API** - æ–°ç‰ˆéœ€è¦WBIï¼Œæ—§ç‰ˆæ•°æ®ä¸å…¨
2. **è§†é¢‘åˆ—è¡¨API** - ä¸¥æ ¼çš„é¢‘ç‡é™åˆ¶
3. **æ•°æ®æ ¼å¼** - ä¸åŒAPIæ ¼å¼ä¸ä¸€è‡´

### è§£å†³ç­–ç•¥
1. **ä½¿ç”¨ç¨³å®šçš„æ›¿ä»£API** - cardã€navnumã€popularç­‰
2. **æ™ºèƒ½é™çº§æœºåˆ¶** - ä¸»APIå¤±è´¥è‡ªåŠ¨åˆ‡æ¢å¤‡ç”¨
3. **ä¸¥æ ¼çš„è¯·æ±‚æ§åˆ¶** - 5-10ç§’é—´éš”ï¼Œé¿å…è§¦å‘é™åˆ¶
4. **æ•°æ®æ ‡å‡†åŒ–** - ç»Ÿä¸€çš„å“åº”æ ¼å¼

### å®æ–½å»ºè®®
âœ… **ç«‹å³å¯ç”¨çš„æ–¹æ¡ˆ**ï¼šä½¿ç”¨ç¨³å®šAPI + å¢åŠ è¯·æ±‚é—´éš” + è‡ªåŠ¨é™çº§

é€šè¿‡è¿™äº›ä¿®å¤ï¼Œå¯ä»¥å°†APIçš„å‡†ç¡®æ€§å’Œç¨³å®šæ€§æå‡åˆ°90%ä»¥ä¸Šï¼Œç¡®ä¿ç”¨æˆ·è·å¾—å¯é çš„æ•°æ®æœåŠ¡ã€‚

---

*æœ¬æŠ¥å‘ŠåŸºäº2025å¹´8æœˆ19æ—¥çš„æµ‹è¯•ç»“æœ*